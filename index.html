<!DOCTYPE html>
<html>
<head>
  <title>Samsung TV Remote HTML App (Updated)</title>
</head>
<body>
  <h2>Samsung TV Remote</h2>
  <label for="tvip">TV IP Address:</label>
  <input id="tvip" type="text" value="192.168.1.x">
  <button onclick="connectTV()">Connect</button>
  <div id="status"></div>
  <br>
  <button onclick="sendKey('KEY_POWER')">Power</button>
  <button onclick="sendKey('KEY_VOLUP')">Volume +</button>
  <button onclick="sendKey('KEY_VOLDOWN')">Volume -</button>
  <button onclick="sendKey('KEY_ENTER')">OK</button>

  <script>
    let ws = null;

    function connectTV() {
      const ip = document.getElementById('tvip').value;
      // Try wss first, fallback to ws if error
      const nameBase64 = btoa('HTML_REMOTE');
      let triedWs = false;

      function openWs(uri) {
        ws = new WebSocket(uri);

        ws.onopen = function() {
          document.getElementById('status').innerText = "Connected via " + (uri.startsWith("wss") ? "wss" : "ws");
        };
        ws.onerror = function(e) {
          if (!triedWs && uri.startsWith("wss")) {
            triedWs = true;
            // Fallback to insecure ws
            openWs('ws://' + ip + ':8001/api/v2/channels/samsung.remote.control?name=' + nameBase64);
          } else {
            document.getElementById('status').innerText = "Connection failed! Check Device Connection settings on TV.";
          }
        };
        ws.onclose = function(e) {
          document.getElementById('status').innerText = "Disconnected! Try resetting Smart Hub & device permissions on TV.";
        };
      }
      openWs('wss://' + ip + ':8002/api/v2/channels/samsung.remote.control?name=' + nameBase64);
    }

    function sendKey(key) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("Please connect first!");
        return;
      }
      const msg = {
        method: "ms.remote.control",
        params: {
          Cmd: "Click",
          DataOfCmd: key,
          Option: "false",
          TypeOfRemote: "SendRemoteKey"
        }
      };
      ws.send(JSON.stringify(msg));
    }
  </script>
</body>
</html>
